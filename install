#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

R='\033[0;31m' #'0;31' is Red's ANSI color code
G='\033[0;32m' #'0;32' is Green's ANSI color code
Y='\033[1;32m' #'1;32' is Yellow's ANSI color code
B='\033[0;34m' #'0;34' is Blue's ANSI color code
NC='\033[0m'   #'0'    is back no color

SKIP_INSTALL=false
SKIP_COMPLETION=false
SKIP_STOW=false

show_help() {
	cat <<EOF
Usage: ./install [OPTIONS]

Options:
  --skip-install    Skip package installation, only refresh config
  --skip-completion Skip generating shell completions
  --skip-stow       Skip stow operations (symlinking dotfiles)
  -h, --help        Show this help message

EOF
}

while [[ $# -gt 0 ]]; do
	case $1 in
	--skip-install)
		SKIP_INSTALL=true
		shift
		;;
	--skip-completion)
		SKIP_COMPLETION=true
		shift
		;;
	--skip-stow)
		SKIP_STOW=true
		shift
		;;
	-h | --help)
		show_help
		exit 0
		;;
	*)
		echo "Unknown option: $1"
		echo "Use --help for usage information"
		exit 1
		;;
	esac
done

# Patch for known bug: A spurious warning is issued when unstowing a package #65
# https://github.com/aspiers/stow/issues/65#issuecomment-757644763
_stow_patch() {
	stow "$@" 2>&1 | grep -v "BUG in find_stowed_path? Absolute/relative mismatch between Stow dir" || true
}

install_configs() {
	echo ""
	echo "------Install configuration files----------"
	echo ""

	# @TODO (undg) 2024-03-15: think about removing this firework. I'm not using it much
	#  @TODO (undg) 2026-02-15: still thinking :)
	rm -rf ~/.config/atuin

	for folder in */; do
		if [[ ! $folder =~ ^_.* ]]; then
			echo "--------------------------"
			_stow_patch -D "$folder"
			echo -e "${R}Remove $folder${NC}"
			_stow_patch "$folder"
			echo -e "${G}Add $folder${NC}"
		fi
	done

	echo "--------------------------"
	echo "All done!"
}

# _install_package - Cross-platform package installer
#
# Installs packages across pacman, brew, pkg (termux), and apt with support for:
# - Different package names per manager
# - Skip unavailable packages with SKIP
# - Check if already installed before attempting install
# - Brew cask support with --cask prefix
#
# Usage:
#   _install_package <pacman_name> [brew_name] [pkg_name] [apt_name]
#
# Arguments:
#   pacman_name - Package name for pacman (required)
#   brew_name   - Package name for brew (optional, defaults to pacman_name)
#                 Prefix with --cask for brew cask packages
#   pkg_name    - Package name for pkg/termux (optional, defaults to pacman_name)
#   apt_name    - Package name for apt (optional, defaults to pacman_name)
#
# Special values:
#   SKIP - Skip installation for this package manager
#
# Examples:
#   _install_package ripgrep                    # same name everywhere
#   _install_package ripgrep ripgrep rg         # different apt name
#   _install_package tv-bin television SKIP     # not available in apt
#   _install_package brave-bin "--cask brave" SKIP # brew cask package
#
_install_package() {
	local pkg_pacman=$1
	local pkg_brew=${2:-$1}
	local pkg_pkg=${3:-$1}
	local pkg_apt=${4:-$1}

	if command -v pacman &>/dev/null; then
		[[ "$pkg_pacman" == "SKIP" ]] && return 0
		if pacman -Q "$pkg_pacman" &>/dev/null; then
			return 0
		elif command -v yay &>/dev/null; then
			yay -S "$pkg_pacman"
		else
			sudo pacman -S "$pkg_pacman"
		fi
	elif command -v brew &>/dev/null; then
		[[ "$pkg_brew" == "SKIP" ]] && return 0
		if [[ "$pkg_brew" == --cask* ]]; then
			local cask_name="${pkg_brew#--cask }"
			brew list --cask "$cask_name" &>/dev/null || brew install --cask "$cask_name"
		else
			brew list "$pkg_brew" &>/dev/null || brew install "$pkg_brew"
		fi
	elif [[ -n "$TERMUX_VERSION" ]] || command -v pkg &>/dev/null; then
		[[ "$pkg_pkg" == "SKIP" ]] && return 0
		pkg list-installed 2>/dev/null | grep -q "^$pkg_pkg/" || pkg install "$pkg_pkg"
	elif command -v apt &>/dev/null; then
		[[ "$pkg_apt" == "SKIP" ]] && return 0
		dpkg -l | grep -q "^ii  $pkg_apt " || sudo apt install "$pkg_apt"
	else
		echo "No supported package manager found"
		return 1
	fi
}

install_packages() {
	echo ""
	echo "------Install missing packages----------"
	echo ""

	_install_package alacritty "--cask alacritty" SKIP
	_install_package arandr SKIP SKIP
	_install_package atuin
	_install_package bluez SKIP SKIP
	_install_package bluez-utils SKIP SKIP
	_install_package brave-bin SKIP SKIP
	_install_package btop btop SKIP btop
	_install_package cmatrix
	_install_package curl
	_install_package downgrade SKIP SKIP SKIP
	_install_package dunst SKIP SKIP SKIP
	_install_package eza
	_install_package fasd SKIP SKIP SKIP
	_install_package fd
	_install_package feh SKIP SKIP SKIP
	_install_package flameshot "--cask flameshot" SKIP SKIP
	_install_package fping SKIP SKIP SKIP
	_install_package git
	_install_package git-delta
	_install_package github-cli gh gh gh
	_install_package i3blocks-contrib-git SKIP SKIP SKIP
	_install_package imagemagick SKIP SKIP SKIP
	_install_package inetutils SKIP SKIP SKIP
	_install_package jq
	_install_package lazydocker lazydocker SKIP lazydocker
	_install_package lazygit
	_install_package luarocks SKIP SKIP SKIP
	_install_package lxqt-policykit SKIP SKIP SKIP
	_install_package man-db SKIP SKIP
	_install_package mise
	_install_package mpv SKIP SKIP
	_install_package neovim
	_install_package nmap
	_install_package obs-studio "--cask obs" SKIP SKIP
	_install_package opencode
	_install_package openssh SKIP openssh openssh
	_install_package pavucontrol SKIP SKIP SKIP
	_install_package picom SKIP SKIP SKIP
	_install_package pipewire SKIP SKIP SKIP
	_install_package pipewire-alsa SKIP SKIP SKIP
	_install_package pipewire-jack SKIP SKIP SKIP
	_install_package pipewire-pulse SKIP SKIP SKIP
	_install_package pulse-remote-git SKIP SKIP SKIP
	_install_package ripgrep
	_install_package rofi SKIP SKIP SKIP
	_install_package rofi-calc SKIP SKIP SKIP
	_install_package rofi-emoji SKIP SKIP SKIP
	_install_package sddm SKIP SKIP SKIP
	_install_package sesh
	_install_package stow
	_install_package the_silver_searcher silversearcher-ag silversearcher-ag silversearcher-ag
	_install_package tig
	_install_package timeshift SKIP SKIP SKIP
	_install_package tmux
	_install_package translate-shell
	_install_package trash-cli
	_install_package ttf-mononoki-nerd SKIP SKIP SKIP
	_install_package television television SKIP SKIP
	_install_package unzip
	_install_package vmware-workstation SKIP SKIP SKIP
	_install_package wget
	_install_package yay SKIP SKIP SKIP
	_install_package zsh
	_install_package zsh-theme-powerlevel10k-git
}

install_completion() {
	echo ""
	echo "------Update autocompletion----------"
	echo ""
	tv init zsh >"$HOME/.config/zsh/completion/_tv"
	tailscale completion zsh >"$HOME/.config/zsh/completion/_tailscale"
	opencode completion zsh >"$HOME/.config/zsh/completion/_opencode"
	pnpm completion zsh >"$HOME/.config/zsh/completion/_pnpm"
}

# Main execution
[[ "$SKIP_INSTALL" == false ]] && install_packages
[[ "$SKIP_COMPLETION" == false ]] && install_completion
[[ "$SKIP_STOW" == false ]] && install_configs
