#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

SKIP_INSTALL=false
SKIP_STOW=false

R='\033[0;31m' #'0;31' is Red's ANSI color code
G='\033[0;32m' #'0;32' is Green's ANSI color code
Y='\033[1;32m' #'1;32' is Yellow's ANSI color code
B='\033[0;34m' #'0;34' is Blue's ANSI color code
NC='\033[0m'   #'0'    is back no color

show_help() {
	cat <<EOF
Usage: ./install [OPTIONS]

Options:
  --skip-install    Skip package installation, only refresh config
  -h, --help        Show this help message

EOF
}

while [[ $# -gt 0 ]]; do
	case $1 in
	--skip-install)
		SKIP_INSTALL=true
		shift
		;;
	--skip-stow)
		SKIP_STOW=true
		shift
		;;
	-h | --help)
		show_help
		exit 0
		;;
	*)
		echo "Unknown option: $1"
		echo "Use --help for usage information"
		exit 1
		;;
	esac
done

echo ""
echo "------Install missing packages----------"
echo ""

# install_package - Cross-platform package installer
#
# Installs packages across pacman, brew, and apt with support for:
# - Different package names per manager
# - Skip unavailable packages with SKIP
# - Check if already installed before attempting install
# - Brew cask support with --cask prefix
#
# Usage:
#   install_package <pacman_name> [brew_name] [apt_name]
#
# Arguments:
#   pacman_name - Package name for pacman (required)
#   brew_name   - Package name for brew (optional, defaults to pacman_name)
#                 Prefix with --cask for brew cask packages
#   apt_name    - Package name for apt (optional, defaults to pacman_name)
#
# Special values:
#   SKIP - Skip installation for this package manager
#
# Examples:
#   install_package ripgrep                    # same name everywhere
#   install_package ripgrep ripgrep rg         # different apt name
#   install_package tv-bin television SKIP     # not available in apt
#   install_package brave-bin --cask brave SKIP # brew cask package
#
install_package() {
	[[ "$SKIP_INSTALL" == true ]] && return 0

	local pkg_pacman=$1
	local pkg_brew=${2:-$1}
	local pkg_apt=${3:-$1}

	if command -v pacman &>/dev/null; then
		[[ "$pkg_pacman" == "SKIP" ]] && return 0
		if pacman -Q "$pkg_pacman" &>/dev/null; then
			return 0
		elif command -v yay &>/dev/null; then
			yay -S "$pkg_pacman"
		else
			pacman -S "$pkg_pacman"
		fi
	elif command -v brew &>/dev/null; then
		[[ "$pkg_brew" == "SKIP" ]] && return 0
		if [[ "$pkg_brew" == --cask* ]]; then
			local cask_name="${pkg_brew#--cask }"
			brew list --cask "$cask_name" &>/dev/null || brew install --cask "$cask_name"
		else
			brew list "$pkg_brew" &>/dev/null || brew install "$pkg_brew"
		fi
	elif command -v apt &>/dev/null; then
		[[ "$pkg_apt" == "SKIP" ]] && return 0
		dpkg -l | grep -q "^ii  $pkg_apt " || sudo apt install "$pkg_apt"
	else
		echo "No supported package manager found"
		return 1
	fi
}

install_package alacritty "--cask alacritty" SKIP
install_package arandr SKIP SKIP
install_package atuin
install_package bluez SKIP SKIP
install_package bluez-utils SKIP SKIP
install_package brave-bin SKIP SKIP
install_package btop
install_package cmatrix
install_package curl
install_package downgrade SKIP SKIP
install_package dunst SKIP SKIP
install_package eza
install_package fasd SKIP SKIP
install_package fd
install_package feh
install_package flameshot "--cask flameshot" flameshot
install_package fping
install_package git
install_package git-delta
install_package github-cli gh
install_package i3blocks-contrib-git SKIP SKIP
install_package imagemagick SKIP SKIP
install_package inetuils SKIP SKIP
install_package jq
install_package lazydocker
install_package lazygit
install_package luarocks SKIP SKIP
install_package lxqt-policykit-agent SKIP SKIP
install_package mad-db SKIP SKIP
install_package mise
install_package mpv SKIP SKIP
install_package neovim
install_package nmap
install_package obs-studio "--cask obs" SKIP
install_package opencode
install_package openssh SKIP
install_package pavucontrol SKIP SKIP
install_package picom SKIP SKIP
install_package pipewire SKIP SKIP
install_package pipewire-alsa SKIP SKIP
install_package pipewire-jack SKIP SKIP
install_package pipewire-pulse SKIP SKIP
install_package prettierd
install_package pulse-remote-git
# install_package pulse-remote-desktop-git
install_package ripgrep
install_package rofi SKIP SKIP
install_package rofi-calc SKIP SKIP
install_package rofi-emoji SKIP SKIP
install_package sddm SKIP SKIP
install_package sesh
install_package stow
install_package the_silver_searcher silversearcher-ag silversearcher-ag
install_package tig
install_package timeshift SKIP
install_package tmux
install_package translate-shell
install_package trash-cli
install_package ttf-mononoki-nerd SKIP SKIP
install_package tv-bin television SKIP
install_package unzip
install_package vmware-workstation
install_package wget
install_package yay-git
install_package zsh
install_package zsh-theme-powerlevel10k-git

echo ""
echo "------Update autocompletion----------"
echo ""
tv init zsh >~/.config/zsh/completion/_tv
tailscale completion zsh >.config/zsh/completion/_tailscale
opencode completion zsh >~/.config/zsh/completion/_opencode
pnpm completion zsh >~/.config/zsh/completion/_pnpm

echo ""
echo "------Install configuration files----------"
echo ""

[[ "$SKIP_STOW" == true ]] && exit 0

# Patch for known bug: A spurious warning is issued when unstowing a package #65
# https://github.com/aspiers/stow/issues/65#issuecomment-757644763
function stow_patch() {
	stow "$@" 2>&1 | grep -v "BUG in find_stowed_path? Absolute/relative mismatch between Stow dir"
}

# @TODO (undg) 2024-03-15: think about removing this firework. I'm not using it much
#  @TODO (undg) 2026-02-15: still thinking
rm -rf ~/.config/atuin

for folder in */; do
	if [[ ! $folder =~ ^_.* ]]; then
		echo "--------------------------"
		stow_patch -D "$folder"
		echo -e "${R}Remove $folder${NC}"
		stow_patch "$folder"
		echo -e "${G}Add $folder${NC}"
	fi
done

echo "--------------------------"
echo "All done!"
